# Eternal Link - 完全仕様書
## デジタル遺産・存在証明プラットフォーム

**バージョン**: 1.0  
**作成日**: 2024年12月29日  
**機密区分**: 社外秘  
**最終更新**: 2024年12月29日

---

# 📑 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [市場分析](#2-市場分析)
3. [システムアーキテクチャ](#3-システムアーキテクチャ)
4. [データベース設計](#4-データベース設計)
5. [機能仕様](#5-機能仕様)
6. [技術スタック](#6-技術スタック)
7. [UI/UX設計](#7-uiux設計)
8. [セキュリティ設計](#8-セキュリティ設計)
9. [ビジネスモデル](#9-ビジネスモデル)
10. [開発ロードマップ](#10-開発ロードマップ)
11. [リスク管理](#11-リスク管理)
12. [品質保証](#12-品質保証)
13. [運用・保守](#13-運用保守)
14. [付録](#14-付録)

---

# 1. プロジェクト概要

## 1.1 プロジェクト名

**Eternal Link（エターナルリンク）**

**タグライン**: 「永遠に続く絆を、デジタルで」

## 1.2 ビジョン・ミッション

### ビジョン
人々の大切な思い出と存在を次世代につなぎ、デジタル時代における新しい形の記憶継承を実現する。

### ミッション
1. 従来のお墓や供養の経済的・物理的負担を軽減する
2. デジタル資産の散逸を防ぎ、適切に管理・継承する
3. 世代を超えた家族の絆を深める
4. 持続可能で意義深い「存在の継承」を可能にする

## 1.3 プロジェクトの目的

### 解決する社会課題
- **従来のお墓の問題**: 高額費用（平均200万円）、維持管理の負担、継承の困難さ
- **デジタル遺産の散逸**: SNS、写真、メッセージなどの重要な記録が失われる
- **世代間断絶**: 先祖や家族の歴史が継承されない
- **終活の複雑さ**: 遺言、供養、資産管理が煩雑で統合されていない

### 提供する価値
- **経済的**: 従来のお墓の1/10以下のコスト
- **利便性**: いつでもどこでもアクセス可能
- **永続性**: クラウドによる半永久的な保存
- **多様性**: 写真、動画、音声、文章など多様な形式に対応
- **プライバシー**: 5段階の柔軟な公開範囲設定

## 1.4 ターゲット市場

### プライマリターゲット
- **40-60代（終活意識層）**
  - 人口: 約4,300万人
  - 特徴: 終活への関心が高い、デジタルに抵抗感が減少
  - ニーズ: 遺産整理、家族への思い出継承

### セカンダリターゲット
- **30-40代（子育て世代）**
  - 人口: 約2,800万人
  - 特徴: デジタルネイティブ、家族との絆重視
  - ニーズ: 子供へのメッセージ、写真整理

### ターシャリターゲット
- **60代以上（シニア層）**
  - 人口: 約4,000万人
  - 特徴: 終活実行段階、デジタル支援必要
  - ニーズ: シンプルな操作、家族との共有

---

# 2. 市場分析

## 2.1 市場規模

### グローバル市場
- **2025年**: 2,601.9億米ドル（約39兆円）
- **2034年**: 7,795.98億米ドル（約117兆円）
- **CAGR**: 12.97%（2025-2034年）
- **出典**: Custom Market Insights

### 日本市場
- **終活関連ビジネス**: 257億3,000万円（2025年）
- **前年比成長率**: 109.7%
- **デジタル終活市場**: 推定50-80億円（2025年）
- **出典**: 矢野経済研究所

### 市場セグメント別規模
| セグメント | 市場規模（日本） | 成長率 |
|-----------|-----------------|--------|
| デジタル遺産管理 | 30億円 | 15% |
| オンライン供養 | 15億円 | 25% |
| 家系図サービス | 10億円 | 10% |
| 終活コンサル | 50億円 | 8% |
| 葬儀・法要DX | 150億円 | 12% |

## 2.2 競合分析

### 主要競合他社

#### 1. Eterneva（米国）
- **事業内容**: 遺灰からメモリアルダイヤモンド制作
- **価格**: $2,999-$75,000
- **強み**: 
  - 高品質な物理商品
  - 有名人の利用実績
  - エモーショナルマーケティング
- **弱み**:
  - 高価格帯
  - デジタルサービスなし
  - 日本未展開

#### 2. Trust & Will（米国）
- **事業内容**: デジタル遺言・信託作成プラットフォーム
- **価格**: $89-$399
- **強み**:
  - 法務対応が充実
  - ユーザー数が多い（100万人以上）
  - 使いやすいUI
- **弱み**:
  - デジタル遺産管理機能が限定的
  - 日本法非対応
  - 供養機能なし

#### 3. Legacy.com（米国）
- **事業内容**: オンライン追悼ページプラットフォーム
- **価格**: 無料-有料プラン
- **強み**:
  - 大規模プラットフォーム
  - 長い運営実績
  - 広範なネットワーク
- **弱み**:
  - 日本展開なし
  - 機能が基本的
  - 家系図機能なし

#### 4. 国内競合（小規模）
- **つながりバンク**: デジタル終活サポート
- **マイエンディングノート**: 終活ノートアプリ
- **フォトブック葬**: 写真整理サービス

### 競合優位性マトリクス

|  | Eternal Link | Eterneva | Trust & Will | Legacy.com |
|--|--------------|----------|--------------|------------|
| **価格競争力** | ⭐⭐⭐⭐⭐ | ⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| **機能の豊富さ** | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ | ⭐⭐ |
| **日本市場適合** | ⭐⭐⭐⭐⭐ | ⭐ | ⭐ | ⭐ |
| **技術革新性** | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ | ⭐⭐ |
| **ブランド力** | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

## 2.3 市場機会

### 競合の空白地帯
1. **日本市場特化型の総合サービスが不在**
2. **家系図とDNA保存の統合サービスなし**
3. **VR/AR供養空間の商用化未達**
4. **AIデジタルツイン機能の実装例少ない**
5. **寺院・葬儀社との連携モデル未確立**

### 参入障壁
- **技術的障壁**: 中程度（既存技術の組み合わせ）
- **法的障壁**: 低（規制が未整備）
- **資本障壁**: 中程度（初期投資5,000万-1億円）
- **ブランド障壁**: 低（市場形成期）

---

# 3. システムアーキテクチャ

## 3.1 全体アーキテクチャ

### システム構成図

```
┌─────────────────────────────────────────────────────────┐
│                    クライアント層                          │
├─────────────────────────────────────────────────────────┤
│  Web Browser (PC/Tablet)  │  Mobile App (iOS/Android)   │
│  - Next.js 14 SSR/SSG     │  - React Native             │
│  - Progressive Web App     │  - Native APIs              │
└─────────────────┬───────────────────────────────────────┘
                  │
                  │ HTTPS / WebSocket
                  ▼
┌─────────────────────────────────────────────────────────┐
│                   CDN / Load Balancer                     │
│              Cloudflare / AWS CloudFront                  │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│                   アプリケーション層                        │
├─────────────────────────────────────────────────────────┤
│  Next.js 14 App Router                                   │
│  ├─ API Routes (REST)                                    │
│  ├─ Server Components                                    │
│  ├─ Server Actions                                       │
│  └─ Middleware (認証・認可)                               │
└─────────────────┬───────────────────────────────────────┘
                  │
        ┌─────────┴─────────┬─────────────┬────────────┐
        ▼                   ▼             ▼            ▼
┌──────────────┐  ┌──────────────┐  ┌─────────┐  ┌─────────┐
│ 認証サービス    │  │ ファイル処理  │  │ AI処理  │  │ 決済    │
│ NextAuth.js   │  │ Sharp/FFmpeg │  │ OpenAI  │  │ Stripe  │
└──────────────┘  └──────────────┘  └─────────┘  └─────────┘
                  │
        ┌─────────┴─────────┬─────────────┬────────────┐
        ▼                   ▼             ▼            ▼
┌──────────────┐  ┌──────────────┐  ┌─────────┐  ┌─────────┐
│ データベース    │  │ キャッシュ    │  │ 検索    │  │ 監視    │
│ PostgreSQL    │  │ Redis        │  │ Elastic │  │ Datadog │
└──────────────┘  └──────────────┘  └─────────┘  └─────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────┐
│                   ストレージ層                             │
├─────────────────────────────────────────────────────────┤
│  AWS S3 / Cloudflare R2                                  │
│  ├─ 標準ストレージ (頻繁アクセス)                           │
│  ├─ Intelligent-Tiering (最適化)                         │
│  └─ Glacier Deep Archive (長期保存)                       │
└─────────────────────────────────────────────────────────┘
```

## 3.2 技術スタック詳細

### フロントエンド
```yaml
フレームワーク:
  - Next.js: 14.0.4 (App Router)
  - React: 18.2.0
  - TypeScript: 5.x

UI/スタイリング:
  - Tailwind CSS: 3.3.0
  - shadcn/ui: latest
  - Radix UI: 各種コンポーネント
  - Lucide React: アイコンライブラリ

状態管理:
  - Zustand: 4.4.7 (軽量な状態管理)
  - React Query: キャッシュ管理

フォーム・バリデーション:
  - React Hook Form: フォーム管理
  - Zod: 3.22.4 (スキーマバリデーション)

3D/グラフィックス:
  - Three.js: 3D供養空間
  - React Three Fiber: React統合
  - D3.js: 家系図可視化
```

### バックエンド
```yaml
ランタイム:
  - Node.js: 18.x LTS

API:
  - Next.js API Routes (REST)
  - Next.js Server Actions (RPC)
  - tRPC: 型安全なAPI（検討中）

データベース:
  - PostgreSQL: 15.x (メインDB)
  - Prisma ORM: 5.8.0
  - MongoDB: メディアメタデータ（検討中）

キャッシュ:
  - Redis: 7.x
  - Redis Stack: JSON・検索機能

認証:
  - NextAuth.js: 4.24.5
  - bcryptjs: 2.4.3 (パスワードハッシュ)
  - jose: JWT処理

ファイル処理:
  - Sharp: 画像処理
  - FFmpeg: 動画処理
  - pdfkit: PDF生成
```

### AI/機械学習
```yaml
テキスト生成:
  - OpenAI GPT-4 API
  - Claude 3 (代替案)

音声合成:
  - ElevenLabs API
  - Google Cloud TTS (代替案)

画像生成:
  - Stable Diffusion
  - DALL-E 3 (高品質用)

顔認識:
  - AWS Rekognition
  - Face-api.js (クライアント側)
```

### インフラ
```yaml
ホスティング:
  - Vercel (推奨)
  - AWS EC2 + ECS (代替案)

データベース:
  - Supabase (推奨)
  - AWS RDS (スケール時)
  - Neon (代替案)

ストレージ:
  - AWS S3 (メイン)
  - Cloudflare R2 (コスト最適化)

CDN:
  - Cloudflare (グローバル配信)
  - AWS CloudFront (代替案)

監視・ログ:
  - Datadog (APM)
  - Sentry (エラー追跡)
  - Vercel Analytics (標準)
```

## 3.3 スケーラビリティ設計

### 水平スケーリング
- **アプリケーションサーバー**: Kubernetes/AWS ECSによる自動スケーリング
- **データベース**: リードレプリカによる読み取り負荷分散
- **キャッシュ**: Redis Clusterによる分散キャッシュ

### 垂直スケーリング
- **データベース**: インスタンスサイズの段階的アップグレード
- **ストレージ**: 無制限の拡張可能性

### パフォーマンス目標
- **ページ読み込み**: < 2秒 (FCP)
- **API応答時間**: < 200ms (P95)
- **画像配信**: < 100ms (CDN経由)
- **同時接続数**: 10,000+ (初期)、100,000+ (スケール後)

---

# 4. データベース設計

## 4.1 ER図

```
┌──────────────┐       ┌──────────────────┐       ┌─────────────────┐
│    users     │1    ∞ │ family_relations │ ∞    1│   users (rel)   │
│              │───────│                  │───────│                 │
│ id (PK)      │       │ id (PK)          │       │                 │
│ email        │       │ user_id (FK)     │       │                 │
│ full_name    │       │ related_user_id  │       │                 │
│ birth_date   │       │ relation_type    │       │                 │
│ death_date   │       │ confirmed        │       │                 │
└──────┬───────┘       └──────────────────┘       └─────────────────┘
       │
       │ 1
       │
       │ ∞
┌──────┴───────┐       ┌──────────────────┐       ┌─────────────────┐
│media_contents│       │message_capsules  │       │ memorial_visits │
│              │       │                  │       │                 │
│ id (PK)      │       │ id (PK)          │       │ id (PK)         │
│ user_id (FK) │       │ sender_id (FK)   │       │ deceased_id(FK) │
│ content_type │       │ recipient_id(FK) │       │ visitor_id (FK) │
│ file_url     │       │ content          │       │ visit_type      │
│ privacy_level│       │ delivery_cond    │       │ message         │
└──────────────┘       └──────────────────┘       └─────────────────┘
```

## 4.2 テーブル定義

### 4.2.1 users（ユーザー）

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK | ユーザーID |
| email | VARCHAR(255) | UNIQUE, NOT NULL | メールアドレス |
| username | VARCHAR(100) | UNIQUE | ユーザー名 |
| password | VARCHAR(255) | | パスワードハッシュ |
| full_name | VARCHAR(200) | | 氏名 |
| birth_date | DATE | | 生年月日 |
| death_date | DATE | | 死亡日 |
| is_deceased | BOOLEAN | DEFAULT FALSE | 故人フラグ |
| profile_photo | TEXT | | プロフィール写真URL |
| bio | TEXT | | 自己紹介 |
| occupation | VARCHAR(200) | | 職業 |
| location | VARCHAR(200) | | 居住地 |
| privacy_level | INTEGER | DEFAULT 3 | プライバシーレベル(1-5) |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 |

**インデックス**:
- `idx_users_email` ON (email)
- `idx_users_username` ON (username)
- `idx_users_is_deceased` ON (is_deceased)

### 4.2.2 family_relationships（家系図関係）

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK | 関係ID |
| user_id | UUID | FK→users | ユーザーID |
| related_user_id | UUID | FK→users | 関連ユーザーID |
| relationship_type | VARCHAR(50) | NOT NULL | 関係種別 |
| confirmed | BOOLEAN | DEFAULT FALSE | 確認済みフラグ |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |

**relationship_type値**:
- `parent` - 親
- `child` - 子
- `spouse` - 配偶者
- `sibling` - 兄弟姉妹
- `grandparent` - 祖父母
- `grandchild` - 孫

**インデックス**:
- `idx_family_user_id` ON (user_id)
- `idx_family_related_user_id` ON (related_user_id)
- `unique_family_relation` ON (user_id, related_user_id, relationship_type) UNIQUE

### 4.2.3 media_contents（メディアコンテンツ）

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK | コンテンツID |
| user_id | UUID | FK→users | ユーザーID |
| content_type | VARCHAR(50) | NOT NULL | コンテンツ種別 |
| file_url | TEXT | NOT NULL | ファイルURL |
| thumbnail | TEXT | | サムネイルURL |
| title | VARCHAR(200) | | タイトル |
| description | TEXT | | 説明文 |
| captured_date | DATE | | 撮影日 |
| privacy_level | INTEGER | DEFAULT 3 | 公開レベル |
| tags | TEXT[] | | タグ配列 |
| file_size | BIGINT | | ファイルサイズ(bytes) |
| mime_type | VARCHAR(100) | | MIMEタイプ |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 |

**content_type値**:
- `photo` - 写真
- `video` - 動画
- `audio` - 音声
- `document` - 文書

**インデックス**:
- `idx_media_user_id` ON (user_id)
- `idx_media_content_type` ON (content_type)
- `idx_media_created_at` ON (created_at DESC)
- `idx_media_tags` ON (tags) USING GIN

### 4.2.4 message_capsules（メッセージカプセル）

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK | メッセージID |
| sender_id | UUID | FK→users | 送信者ID |
| recipient_id | UUID | FK→users | 受信者ID |
| message_type | VARCHAR(50) | NOT NULL | メッセージ種別 |
| content | TEXT | | テキストコンテンツ |
| media_url | TEXT | | メディアURL |
| delivery_condition | VARCHAR(100) | | 配信条件 |
| is_delivered | BOOLEAN | DEFAULT FALSE | 配信済みフラグ |
| delivered_at | TIMESTAMP | | 配信日時 |
| scheduled_delivery | TIMESTAMP | | 予定配信日時 |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |

**delivery_condition形式**:
- `date:YYYY-MM-DD` - 特定日付
- `age:XX` - 受信者が特定年齢到達時
- `event:graduation` - イベント発生時

**インデックス**:
- `idx_message_sender` ON (sender_id)
- `idx_message_recipient` ON (recipient_id)
- `idx_message_is_delivered` ON (is_delivered)
- `idx_message_scheduled` ON (scheduled_delivery)

### 4.2.5 access_permissions（アクセス権限）

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK | 権限ID |
| user_id | UUID | FK→users | 権限付与者ID |
| granted_user_id | UUID | FK→users | 権限受取者ID |
| permission_level | INTEGER | NOT NULL | 権限レベル(1-5) |
| content_type | VARCHAR(50) | DEFAULT 'all' | コンテンツ種別 |
| granted_at | TIMESTAMP | DEFAULT NOW() | 付与日時 |

**permission_level**:
- `1` - 本人のみ（完全アクセス）
- `2` - 家族（詳細情報）
- `3` - 親戚・親しい友人（基本情報+α）
- `4` - 知人（公開情報）
- `5` - 一般公開（誰でも閲覧可能）

**インデックス**:
- `unique_permission` ON (user_id, granted_user_id, content_type) UNIQUE

### 4.2.6 memorial_visits（供養訪問記録）

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK | 訪問ID |
| deceased_user_id | UUID | FK→users | 故人ID |
| visitor_id | UUID | FK→users | 訪問者ID |
| visit_type | VARCHAR(50) | NOT NULL | 訪問種別 |
| message | TEXT | | メッセージ |
| offering_type | VARCHAR(50) | | お供え物種別 |
| visited_at | TIMESTAMP | DEFAULT NOW() | 訪問日時 |

**visit_type値**:
- `prayer` - お参り
- `offering` - お供え
- `message` - メッセージ残し

**offering_type値**:
- `flowers` - お花
- `incense` - お線香
- `candle` - ろうそく

### 4.2.7 dna_records（DNA保存記録）

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK | 記録ID |
| user_id | UUID | FK→users | ユーザーID |
| sample_type | VARCHAR(50) | NOT NULL | サンプル種別 |
| storage_location | VARCHAR(200) | | 保管場所 |
| collection_date | DATE | NOT NULL | 採取日 |
| genetic_data_url | TEXT | | 遺伝子データURL（暗号化） |
| status | VARCHAR(50) | DEFAULT 'pending' | ステータス |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |

**sample_type値**:
- `tooth` - 歯
- `hair` - 毛髪
- `saliva` - 唾液

**status値**:
- `pending` - 保留中
- `stored` - 保管済み
- `analyzed` - 解析済み

### 4.2.8 timelines（タイムラインイベント）

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK | イベントID |
| user_id | UUID | FK→users | ユーザーID |
| event_type | VARCHAR(50) | NOT NULL | イベント種別 |
| title | VARCHAR(200) | NOT NULL | タイトル |
| description | TEXT | | 説明文 |
| event_date | DATE | NOT NULL | イベント日付 |
| photos | TEXT[] | | 写真URL配列 |
| location | VARCHAR(200) | | 場所 |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT NOW() | 更新日時 |

**event_type値**:
- `birth` - 誕生
- `marriage` - 結婚
- `graduation` - 卒業
- `career` - キャリア
- `achievement` - 功績
- `custom` - カスタム

### 4.2.9 qr_codes（QRコード）

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK | QRコードID |
| code | VARCHAR(100) | UNIQUE, NOT NULL | QRコードユニーク識別子 |
| user_id | UUID | FK→users | ユーザーID |
| type | VARCHAR(50) | NOT NULL | QRコード種別 |
| is_active | BOOLEAN | DEFAULT TRUE | 有効フラグ |
| scans | INTEGER | DEFAULT 0 | スキャン回数 |
| created_at | TIMESTAMP | DEFAULT NOW() | 作成日時 |
| last_scanned | TIMESTAMP | | 最終スキャン日時 |

**type値**:
- `memorial` - メモリアルページ
- `profile` - プロフィールページ
- `timeline` - タイムライン

### 4.2.10 accounts & sessions（NextAuth関連）

NextAuthが自動管理するテーブル。詳細はNextAuthドキュメント参照。

## 4.3 データベースパフォーマンス最適化

### インデックス戦略
- **B-tree**: 通常の検索・ソート
- **GIN**: 配列・全文検索
- **GiST**: 地理情報（将来実装時）

### パーティショニング
- **タイムライン**: 年次パーティション
- **メディアコンテンツ**: 月次パーティション
- **訪問記録**: 月次パーティション

### クエリ最適化
- **N+1問題**: Prisma includeの適切な使用
- **ページネーション**: カーソルベースページング
- **集計クエリ**: マテリアライズドビュー

---

# 5. 機能仕様

## 5.1 ユーザー認証・認可

### 5.1.1 ユーザー登録

**機能概要**: 新規ユーザーがアカウントを作成する

**入力項目**:
- メールアドレス（必須、ユニーク）
- パスワード（必須、8文字以上、英数字記号混在推奨）
- 氏名（必須）
- 生年月日（任意）

**処理フロー**:
1. 入力バリデーション（Zod）
2. メールアドレス重複チェック
3. パスワードハッシュ化（bcrypt、ソルトラウンド10）
4. データベース登録
5. ウェルカムメール送信（オプション）
6. 自動ログイン or ログインページ遷移

**バリデーションルール**:
```typescript
const registerSchema = z.object({
  email: z.string().email('有効なメールアドレスを入力してください'),
  password: z.string()
    .min(8, 'パスワードは8文字以上である必要があります')
    .regex(/[A-Z]/, '大文字を1文字以上含める必要があります')
    .regex(/[a-z]/, '小文字を1文字以上含める必要があります')
    .regex(/[0-9]/, '数字を1文字以上含める必要があります'),
  fullName: z.string().min(1, '氏名を入力してください'),
  birthDate: z.date().optional(),
})
```

**エラーハンドリング**:
- メールアドレス重複: `400 - このメールアドレスは既に登録されています`
- バリデーション失敗: `400 - {具体的なエラーメッセージ}`
- サーバーエラー: `500 - 登録中にエラーが発生しました`

### 5.1.2 ログイン

**機能概要**: 既存ユーザーがシステムにログインする

**入力項目**:
- メールアドレス（必須）
- パスワード（必須）
- ログイン状態を保持（オプション）

**処理フロー**:
1. 入力バリデーション
2. ユーザー存在チェック
3. パスワード検証（bcrypt.compare）
4. JWTトークン生成（NextAuth）
5. セッション作成
6. ダッシュボードにリダイレクト

**セキュリティ対策**:
- レート制限: 5回失敗で15分ロック
- ブルートフォース対策: IP単位での制限
- セッション有効期限: 30日（記憶する場合）、1日（デフォルト）

### 5.1.3 ログアウト

**処理**:
1. セッショントークン無効化
2. クッキークリア
3. ログインページにリダイレクト

### 5.1.4 パスワードリセット

**処理フロー**:
1. メールアドレス入力
2. リセットトークン生成（UUID、有効期限1時間）
3. リセットリンク付きメール送信
4. リンククリックで新パスワード設定画面
5. 新パスワード登録とトークン無効化

### 5.1.5 二段階認証（2FA）（Phase 2実装）

**対応方式**:
- TOTP（Time-based One-Time Password）
- SMS認証
- バックアップコード

## 5.2 デジタルメモリアルスペース

### 5.2.1 プロフィールページ

**機能概要**: ユーザーの詳細情報を表示・編集するページ

**表示項目**:
- プロフィール写真
- 基本情報（氏名、生年月日、居住地、職業）
- 自己紹介文
- 人生のマイルストーン
- 統計情報（アップロード数、家族数、訪問回数）

**編集可能項目**:
- プロフィール写真（最大5MB）
- 氏名
- 生年月日
- 居住地
- 職業
- 自己紹介（最大1,000文字）
- プライバシーレベル（1-5）

**画面レイアウト**:
```
┌────────────────────────────────────────┐
│  ヘッダー（ナビゲーション）                │
├────────────────────────────────────────┤
│  [プロフィール写真]                       │
│                                        │
│  氏名              [編集ボタン]          │
│  生年月日 - 現在XX歳                     │
│  居住地                                 │
│  職業                                   │
│                                        │
│  自己紹介文...                          │
│                                        │
├────────────────────────────────────────┤
│  統計情報                               │
│  ┌──────┐ ┌──────┐ ┌──────┐         │
│  │ 写真  │ │ 家族  │ │ 訪問  │         │
│  │ 123件 │ │ 12人  │ │ 456回 │         │
│  └──────┘ └──────┘ └──────┘         │
├────────────────────────────────────────┤
│  タイムライン                            │
│  ・2024年 - イベント名                   │
│  ・2023年 - イベント名                   │
│  ...                                   │
└────────────────────────────────────────┘
```

### 5.2.2 メディアギャラリー

**機能概要**: 写真・動画・音声を整理・表示する

**対応形式**:
- 画像: JPEG, PNG, WebP, GIF（10MB以下）
- 動画: MP4, MOV, AVI（500MB以下）
- 音声: MP3, WAV, OGG（50MB以下）

**機能詳細**:

#### アップロード
- ドラッグ&ドロップ対応
- 複数ファイル同時アップロード（最大20ファイル）
- プログレスバー表示
- サムネイル自動生成
- EXIF情報自動抽出（撮影日時、位置情報）

#### 表示・閲覧
- グリッド表示（2/3/4/6カラム選択可）
- ライトボックス表示
- スライドショー再生
- フルスクリーン表示

#### 整理・管理
- フォルダ作成・移動
- タグ付け
- お気に入り登録
- 撮影日でのソート
- タイトル・説明追加
- 一括編集

#### 検索・フィルタリング
- タグ検索
- 日付範囲指定
- ファイル種別フィルタ
- フルテキスト検索（タイトル・説明文）

**UI例**:
```
┌────────────────────────────────────────┐
│ [アップロード] [新規フォルダ] [検索___] │
├────────────────────────────────────────┤
│ フィルタ: [全て▼] [タグ▼] [日付▼]      │
├────────────────────────────────────────┤
│ ┌──────┐ ┌──────┐ ┌──────┐           │
│ │photo1│ │photo2│ │photo3│           │
│ │2024  │ │2024  │ │2023  │           │
│ └──────┘ └──────┘ └──────┘           │
│ ┌──────┐ ┌──────┐ ┌──────┐           │
│ │video1│ │photo4│ │photo5│           │
│ └──────┘ └──────┘ └──────┘           │
└────────────────────────────────────────┘
```

### 5.2.3 未来へのメッセージカプセル

**機能概要**: 特定の条件で配信されるメッセージを作成

**メッセージ種別**:
- テキストメッセージ
- ビデオメッセージ
- 音声メッセージ

**配信条件設定**:
1. **日付指定**
   - 特定の日付（例: 2030年1月1日）
   - 記念日（誕生日、結婚記念日等）

2. **年齢指定**
   - 受信者が特定年齢に到達（例: 20歳、成人）

3. **イベント指定**
   - 卒業
   - 結婚
   - 出産
   - その他カスタムイベント

4. **死後配信**
   - 本人の死亡確認後に自動配信

**作成フロー**:
1. メッセージ種別選択
2. 受信者選択（家族メンバーから）
3. メッセージ内容作成
   - テキスト: リッチエディタ（最大10,000文字）
   - ビデオ: アップロードまたは録画（最大5分）
   - 音声: アップロードまたは録音（最大10分）
4. 配信条件設定
5. プレビュー確認
6. 保存

**通知方法**:
- メール通知
- アプリ内通知
- SMS通知（オプション）

### 5.2.4 人生タイムライン

**機能概要**: 人生の重要なイベントを時系列で記録

**イベント種別**:
- 誕生
- 入学・卒業
- 就職・転職
- 結婚
- 出産
- 受賞・功績
- 旅行
- カスタムイベント

**イベント情報**:
- タイトル（必須）
- 日付（必須）
- 説明文（任意）
- 写真（最大10枚）
- 場所（任意）
- 参加者（家族メンバーから選択）

**表示形式**:
- 縦型タイムライン（デフォルト）
- 横型タイムライン
- カレンダービュー
- 年表ビュー

## 5.3 家系図機能

### 5.3.1 家系図作成・編集

**機能概要**: インタラクティブな家系図を作成・編集

**対応関係**:
- 親子関係
- 配偶者関係
- 兄弟姉妹関係
- 祖父母-孫関係

**家系図表示**:
```
        [祖父]━━[祖母]
           │
    ┌──────┴──────┐
   [父]━━━━[母]    [叔父]
      │
  ┌───┼───┐
 [兄] [本人] [妹]
```

**機能詳細**:

#### メンバー追加
1. 「メンバー追加」ボタンクリック
2. 関係性選択（親、子、配偶者等）
3. 基準となる人物選択
4. 新規登録 or 既存ユーザー招待
5. 基本情報入力
   - 氏名
   - 生年月日
   - 死亡日（故人の場合）
   - プロフィール写真

#### 関係性編集
- ドラッグ&ドロップで関係変更
- 右クリックメニューで関係追加・削除
- 離婚・再婚の表現

#### 表示設定
- ズームイン/アウト
- フルスクリーン表示
- PDF/画像エクスポート
- 印刷最適化

#### 招待機能
1. 家族メンバーにメール招待
2. 招待リンク生成
3. 受信者が登録完了
4. 自動的に家系図に追加

**プライバシー設定**:
- 家系図全体の公開範囲
- 個人ごとの情報公開範囲

### 5.3.2 DNA保存サービス（Phase 2実装）

**提供内容**:
- DNA採取キット郵送
- 専門機関での保管
- 遺伝子情報のデジタル記録
- 世代間の遺伝変化追跡

**利用料金**:
- 初回採取・保管: ¥50,000
- 年間保管料: ¥5,000
- 遺伝子解析: ¥30,000~

**パートナー機関**:
- 検査機関との連携
- セキュアな保管施設

## 5.4 バーチャル供養システム

### 5.4.1 デジタル墓地

**機能概要**: 3D空間でのバーチャル墓地

**環境設定**:
- 墓地タイプ選択（和風、洋風、モダン）
- 背景選択（森、海、山、都市）
- 時間帯設定（朝、昼、夕方、夜）
- 天候設定（晴れ、曇り、雨、雪）

**墓石カスタマイズ**:
- 形状選択（10種類以上）
- 色・材質選択
- 刻印文字編集
- QRコード埋め込み

**インタラクション**:
- 墓前移動（WASD/矢印キー）
- 視点変更（マウスドラッグ）
- お供え物設置
- お参りアクション

**技術実装**:
- Three.js / React Three Fiber
- WebGL対応ブラウザ必須
- VRヘッドセット対応（Phase 2）

### 5.4.2 オンライン法要

**機能概要**: リモートでの法要実施

**提供サービス**:
1. **Zoom法要**
   - 提携寺院と接続
   - 最大50名参加可能
   - 録画機能
   - 画面共有（写真スライドショー）

2. **法要プラン**
   - 初七日法要: ¥30,000
   - 四十九日法要: ¥50,000
   - 一周忌法要: ¥50,000
   - 年回忌法要: ¥30,000

3. **手続きフロー**
   - 日時・プラン選択
   - 参加者招待
   - 決済
   - リマインダー通知
   - 法要実施
   - 録画アーカイブ提供

**提携寺院管理**:
- 寺院登録・審査
- スケジュール管理
- 手数料支払い（20%）
- レビュー・評価システム

### 5.4.3 お参り・お供え

**お参りアクション**:
- 合掌（アニメーション）
- メッセージ書き込み
- お花を添える
- お線香を上げる
- ろうそくを灯す

**デジタルお供え物**:
| 種類 | 価格 | 説明 |
|-----|------|------|
| お花（バラ） | ¥100 | 赤・白・黄色 |
| お花（菊） | ¥100 | 白・黄色 |
| お線香 | ¥50 | 煙のエフェクト |
| ろうそく | ¥50 | 炎のエフェクト |
| お菓子 | ¥200 | 3D モデル |
| お酒 | ¥300 | 3Dモデル |

**お参り記録**:
- 訪問日時記録
- メッセージアーカイブ
- お供え物履歴
- 訪問者リスト

### 5.4.4 QRコード連携

**機能概要**: 物理的な墓石とデジタル空間を連携

**提供製品**:
- QRコード付きプレート（ステンレス製、耐久性10年以上）
- サイズ: 5cm × 5cm / 10cm × 10cm
- 価格: ¥30,000 / ¥50,000

**QRコード機能**:
1. スキャンでデジタル墓地にアクセス
2. 故人の情報表示
3. タイムライン閲覧
4. メッセージ投稿
5. AR機能（Phase 2）
   - 墓石に情報重畳表示
   - 3Dホログラム表示

**生成・管理**:
- 自動生成（UUID）
- 有効化/無効化
- スキャン回数トラッキング
- 不正アクセス検知

## 5.5 アクセス権限管理

### 5.5.1 多層権限システム

**5段階の権限レベル**:

| レベル | 名称 | アクセス可能範囲 | 対象者 |
|-------|------|-----------------|--------|
| 1 | 本人のみ | すべての情報・機能 | 本人 |
| 2 | 家族 | 詳細情報、プライベート写真、未配信メッセージ一覧 | 配偶者、子供、親 |
| 3 | 親戚・親しい友人 | 基本情報、公開写真、タイムライン | 兄弟姉妹、親友 |
| 4 | 知人 | 公開プロフィール、一部のタイムライン | 友人、同僚 |
| 5 | 一般公開 | 基本プロフィール、公開設定コンテンツのみ | すべての人 |

### 5.5.2 コンテンツ別権限設定

**設定可能項目**:
- プロフィール情報全体
- 各メディアファイル個別
- タイムラインイベント個別
- メッセージカプセル
- 家系図情報
- DNA情報

**設定UI**:
```
┌────────────────────────────────────────┐
│ プライバシー設定                         │
├────────────────────────────────────────┤
│ プロフィール全体の公開範囲               │
│ [●親戚・親しい友人（レベル3）  ▼]      │
│                                        │
│ 個別コンテンツの設定                    │
│ ┌──────────────────────────────┐    │
│ │ 写真: family_photo_2024.jpg    │    │
│ │ 公開範囲: [家族のみ ▼]         │    │
│ │ [保存]                         │    │
│ └──────────────────────────────┘    │
│                                        │
│ 家族メンバー別権限                      │
│ ┌──────────────────────────────┐    │
│ │ 山田太郎（息子）                │    │
│ │ [✓] 全コンテンツ閲覧            │    │
│ │ [✓] 編集権限                    │    │
│ │ [✓] メッセージカプセル管理       │    │
│ └──────────────────────────────┘    │
└────────────────────────────────────┘
```

### 5.5.3 アクセスログ

**記録項目**:
- アクセス日時
- アクセスユーザー
- 閲覧コンテンツ
- 実行アクション
- IPアドレス
- デバイス情報

**不正アクセス検知**:
- 異常なアクセス頻度
- 通常と異なる地域からのアクセス
- 複数デバイスからの同時アクセス
- 権限外コンテンツへのアクセス試行

## 5.6 AI支援機能（Phase 2実装）

### 5.6.1 AIライティング支援

**機能**:
- 自分史の執筆サポート
- メッセージの文章化
- 思い出の整理・構成提案
- 多言語翻訳（10言語対応）

**使用モデル**:
- OpenAI GPT-4
- Claude 3（代替案）

**実装例**:
```typescript
const generateLifeStory = async (keyEvents: Event[]) => {
  const prompt = `
    以下のライフイベントを基に、感動的な自分史を執筆してください。
    
    イベント:
    ${keyEvents.map(e => `- ${e.date}: ${e.title}`).join('\n')}
    
    要件:
    - 温かみのある文体
    - 各イベントの意義を深掘り
    - 家族への感謝を織り込む
    - 2000-3000文字程度
  `
  
  const response = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [{ role: 'user', content: prompt }],
    temperature: 0.7,
  })
  
  return response.choices[0].message.content
}
```

### 5.6.2 写真・動画編集サービス

**自動編集**:
- 顔認識による人物分類
- 重複写真の自動削除
- 画質向上（AI超解像）
- 自動タグ付け

**プロフェッショナルサービス**:
- プロ撮影手配（¥50,000〜）
- 既存写真の高品質化（¥5,000/枚）
- ビデオメッセージ編集（¥30,000〜）
- スライドショー制作（¥20,000〜）

### 5.6.3 AIアバター・音声合成（Phase 3実装）

**デジタルツイン作成**:
1. 本人の写真・動画収集（最低30枚、10分）
2. 音声データ収集（最低30分）
3. AI学習（3-7日）
4. デジタルアバター生成

**機能**:
- テキストから音声生成（本人の声で）
- 簡単な対話応答
- 動画メッセージ生成

**技術**:
- ElevenLabs（音声合成）
- D-ID / Synthesia（動画合成）
- GPT-4（対話生成）

**倫理的配慮**:
- 本人の明示的同意必須
- 利用目的の制限
- 悪用防止の技術的対策
- 家族の承認プロセス

## 5.7 管理機能

### 5.7.1 ダッシュボード

**表示内容**:
- ウェルカムメッセージ
- 統計サマリー
  - 保存した思い出数
  - 家族のつながり数
  - 未来へのメッセージ数
  - 供養の記録数
- クイックアクション
  - 思い出アップロード
  - 家族を招待
  - メッセージ作成
  - お参りする
- 最近の活動
  - 最近アップロードした写真
  - 最近の訪問者
  - 未読通知
- リマインダー
  - 記念日通知
  - メッセージ配信予定
  - 更新推奨項目

### 5.7.2 設定画面

**アカウント設定**:
- プロフィール編集
- メールアドレス変更
- パスワード変更
- アカウント削除

**プライバシー設定**:
- デフォルト公開範囲
- 検索可能性
- 位置情報利用
- データダウンロード

**通知設定**:
- メール通知
- プッシュ通知
- SMS通知
- 通知頻度

**課金・プラン**:
- 現在のプラン表示
- プラン変更
- 決済方法管理
- 請求履歴
- ストレージ使用量

**セキュリティ設定**:
- 二段階認証（2FA）
- ログインデバイス一覧
- アクセスログ閲覧
- セッション管理

---

# 6. 技術スタック

## 6.1 開発環境

### 必須ツール
- Node.js: 18.x LTS以上
- npm: 9.x以上 または yarn: 1.22.x以上
- Git: 2.x以上
- PostgreSQL: 15.x以上
- Redis: 7.x以上（開発時はローカル、本番はクラウド）

### 推奨エディタ
- Visual Studio Code
  - 拡張機能:
    - ESLint
    - Prettier
    - Prisma
    - Tailwind CSS IntelliSense
    - GitLens

### 開発用データベース
- Docker Composeで構築
```yaml
version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: eternal_link_dev
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: devpassword
    ports:
      - "5432:5432"
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

## 6.2 コーディング規約

### TypeScript
- 厳格な型チェック有効化
```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true
  }
}
```

### 命名規則
- **ファイル名**: kebab-case（例: `user-profile.tsx`）
- **コンポーネント**: PascalCase（例: `UserProfile`）
- **関数・変数**: camelCase（例: `getUserData`）
- **定数**: UPPER_SNAKE_CASE（例: `MAX_FILE_SIZE`）
- **型・インターフェース**: PascalCase（例: `UserData`）

### コメント規約
```typescript
/**
 * ユーザープロフィールを取得する
 * @param userId - ユーザーID
 * @returns ユーザープロフィールデータ
 * @throws {NotFoundError} ユーザーが見つからない場合
 */
async function getUserProfile(userId: string): Promise<UserProfile> {
  // 実装...
}
```

## 6.3 テスト戦略

### テストピラミッド
```
        /\
       /E2E\        <- 10% (重要フロー)
      /──────\
     /Integration\ <- 20% (API・DB)
    /────────────\
   /  Unit Tests  \ <- 70% (ロジック)
  /────────────────\
```

### テストツール
- **Unit**: Jest + React Testing Library
- **Integration**: Jest + Supertest
- **E2E**: Playwright
- **カバレッジ目標**: 80%以上

### テスト例
```typescript
// Unit Test
describe('calculateAge', () => {
  it('正しく年齢を計算する', () => {
    const birthDate = new Date('1990-01-01')
    const age = calculateAge(birthDate)
    expect(age).toBe(34) // 2024年基準
  })
})

// Integration Test
describe('POST /api/auth/register', () => {
  it('新規ユーザーを登録できる', async () => {
    const response = await request(app)
      .post('/api/auth/register')
      .send({
        email: 'test@example.com',
        password: 'Password123',
        fullName: 'Test User'
      })
    
    expect(response.status).toBe(201)
    expect(response.body).toHaveProperty('user.id')
  })
})
```

## 6.4 CI/CD パイプライン

### GitHub Actions ワークフロー
```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run type check
        run: npm run type-check
      
      - name: Run tests
        run: npm test -- --coverage
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      
      - name: Build
        run: npm run build
      
      - name: Deploy to Vercel
        if: github.ref == 'refs/heads/main'
        run: vercel --prod
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
```

---

# 7. UI/UX設計

## 7.1 デザインシステム

### カラーパレット
```css
:root {
  /* Primary */
  --primary-50: #f0f4ff;
  --primary-100: #e0e9ff;
  --primary-500: #667eea;  /* メインカラー */
  --primary-700: #4c56d8;
  --primary-900: #3730a3;
  
  /* Secondary */
  --secondary-50: #faf5ff;
  --secondary-500: #764ba2;  /* サブカラー */
  --secondary-900: #581c87;
  
  /* Neutral */
  --gray-50: #f9fafb;
  --gray-500: #6b7280;
  --gray-900: #111827;
  
  /* Semantic */
  --success: #10b981;
  --warning: #f59e0b;
  --error: #ef4444;
  --info: #3b82f6;
}
```

### タイポグラフィ
```css
/* 見出し */
h1 { font-size: 2.5rem; font-weight: 700; line-height: 1.2; }
h2 { font-size: 2rem; font-weight: 600; line-height: 1.3; }
h3 { font-size: 1.5rem; font-weight: 600; line-height: 1.4; }

/* 本文 */
body { font-size: 1rem; font-weight: 400; line-height: 1.6; }
small { font-size: 0.875rem; }

/* フォントファミリー */
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
```

### スペーシング
```css
/* 8pxベースのスペーシングシステム */
--space-1: 0.25rem;  /* 4px */
--space-2: 0.5rem;   /* 8px */
--space-3: 0.75rem;  /* 12px */
--space-4: 1rem;     /* 16px */
--space-6: 1.5rem;   /* 24px */
--space-8: 2rem;     /* 32px */
--space-12: 3rem;    /* 48px */
--space-16: 4rem;    /* 64px */
```

## 7.2 レスポンシブデザイン

### ブレークポイント
```css
/* Tailwind CSS標準 */
sm: 640px   /* スマートフォン（横） */
md: 768px   /* タブレット */
lg: 1024px  /* デスクトップ（小） */
xl: 1280px  /* デスクトップ（中） */
2xl: 1536px /* デスクトップ（大） */
```

### レスポンシブ戦略
- **モバイルファースト**: 小画面から設計
- **フルード対応**: 柔軟なグリッドシステム
- **タッチ対応**: 44px以上のタップ領域
- **画像最適化**: srcsetによる解像度対応

## 7.3 アクセシビリティ

### WCAG 2.1 AA準拠

**キーボード操作**:
- すべての機能をキーボードで操作可能
- フォーカス表示の明確化
- Tab順序の論理的配置

**スクリーンリーダー対応**:
- セマンティックHTML使用
- ARIAラベル適切設定
- alt属性の適切な記述

**色覚対応**:
- コントラスト比 4.5:1以上（本文）
- コントラスト比 3:1以上（大きな文字）
- 色だけに依存しない情報伝達

**実装例**:
```tsx
<button
  aria-label="プロフィールを編集"
  className="focus:ring-2 focus:ring-primary-500"
>
  <EditIcon aria-hidden="true" />
  編集
</button>
```

## 7.4 高齢者向け配慮

### デザインガイドライン
1. **フォントサイズ**: 最小16px（推奨18px）
2. **行間**: 1.5〜1.8
3. **ボタンサイズ**: 最小44×44px
4. **コントラスト**: 高めに設定（7:1推奨）
5. **アニメーション**: 控えめ（無効化オプション提供）

### シニアモード
```typescript
// シニアモード設定
const seniorModeStyles = {
  fontSize: '125%',     // 1.25倍
  lineHeight: 1.8,
  buttonPadding: '1rem 2rem',
  reduceMotion: true,
}
```

---

# 8. セキュリティ設計

## 8.1 認証・認可

### パスワードポリシー
- 最小8文字
- 大文字・小文字・数字を各1文字以上含む
- 記号推奨
- パスワード履歴（過去5回分と重複不可）
- 有効期限: 90日（オプション）

### セッション管理
- JWT使用
- アクセストークン: 15分
- リフレッシュトークン: 30日
- HTTPS必須
- Secure/HttpOnly/SameSite属性設定

### 二段階認証（2FA）
- TOTP（RFC 6238準拠）
- バックアップコード10個生成
- 回復用メールアドレス設定

## 8.2 データ保護

### 暗号化
- **転送時**: TLS 1.3
- **保存時**: AES-256-GCM
- **パスワード**: bcrypt（ラウンド10）
- **機密データ**: 個別暗号化（DNA情報、決済情報）

### データマスキング
```typescript
// 個人情報のマスキング例
const maskEmail = (email: string) => {
  const [local, domain] = email.split('@')
  return `${local.slice(0, 2)}***@${domain}`
}
// => 'ya***@example.com'

const maskPhone = (phone: string) => {
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1-****-$2')
}
// => '090-****-1234'
```

## 8.3 脆弱性対策

### OWASP Top 10対策

| 脆弱性 | 対策 |
|--------|------|
| インジェクション | Prismaの型安全なクエリ、入力バリデーション |
| 認証の不備 | NextAuth.js、2FA、セッション管理 |
| データ漏洩 | 暗号化、アクセス制御、最小権限原則 |
| XXE | XMLパーサー無効化、JSON使用 |
| アクセス制御 | ロールベースアクセス制御（RBAC） |
| セキュリティ設定ミス | セキュリティヘッダー、デフォルト無効化 |
| XSS | React自動エスケープ、CSP設定 |
| 安全でないデシリアライゼーション | 署名検証、信頼できる入力のみ |
| 既知の脆弱性 | 依存関係の定期更新、Snyk監視 |
| 不十分なログ記録 | 詳細な監査ログ、異常検知 |

### セキュリティヘッダー
```typescript
// next.config.js
const securityHeaders = [
  {
    key: 'X-DNS-Prefetch-Control',
    value: 'on'
  },
  {
    key: 'Strict-Transport-Security',
    value: 'max-age=63072000; includeSubDomains; preload'
  },
  {
    key: 'X-Frame-Options',
    value: 'SAMEORIGIN'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block'
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin'
  },
  {
    key: 'Content-Security-Policy',
    value: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
  }
]
```

## 8.4 監査とコンプライアンス

### 監査ログ
記録対象:
- ログイン/ログアウト
- プロフィール変更
- 権限変更
- データダウンロード
- アカウント削除
- 管理者操作

保存期間: 2年

### コンプライアンス
- **個人情報保護法**: 同意取得、利用目的明示
- **GDPR**: データポータビリティ、削除権
- **PCI DSS**: 決済情報の適切な取り扱い（Stripe利用で簡素化）

---

# 9. ビジネスモデル

## 9.1 収益モデル

### サブスクリプション収益
```
月次経常収益（MRR）予測:

Year 1:
- 無料ユーザー: 8,000人 × ¥0 = ¥0
- プレミアム: 1,500人 × ¥980 = ¥1,470,000
- ファミリー: 300人 × ¥2,980 = ¥894,000
- 永久プラン: 200人 × ¥98,000（一括） = ¥19,600,000（÷12≒¥1,633,333/月）
月次合計: ¥3,997,333
年間合計: 約¥48百万

Year 3:
- 無料: 50,000人
- プレミアム: 10,000人 × ¥980 = ¥9,800,000
- ファミリー: 2,500人 × ¥2,980 = ¥7,450,000
- 永久プラン: 1,500人（累計）
月次合計: ¥17,250,000
年間合計: 約¥207百万
```

### 付加価値サービス収益
| サービス | 単価 | 月間件数（Year 3） | 月間収益 |
|---------|------|-------------------|---------|
| プロ撮影 | ¥50,000 | 20件 | ¥1,000,000 |
| ビデオ編集 | ¥30,000 | 30件 | ¥900,000 |
| 自分史執筆 | ¥100,000 | 10件 | ¥1,000,000 |
| オンライン法要 | ¥40,000 | 50件 | ¥2,000,000 |
| DNA保存 | ¥50,000 | 15件 | ¥750,000 |
| **合計** | - | - | **¥5,650,000** |

### B2B収益
| 顧客セグメント | 単価/月 | 契約数（Year 3） | 月間収益 |
|---------------|--------|----------------|---------|
| 寺院 | ¥50,000 | 50寺 | ¥2,500,000 |
| 葬儀社 | ¥30,000 | 100社 | ¥3,000,000 |
| 企業（福利厚生） | ¥100,000 | 20社 | ¥2,000,000 |
| **合計** | - | - | **¥7,500,000** |

### 総収益予測（Year 3）
```
サブスクリプション: ¥17,250,000
付加価値サービス:    ¥5,650,000
B2B:                 ¥7,500,000
────────────────────────────────
月間総収益:          ¥30,400,000
年間総収益:          ¥364,800,000
```

## 9.2 コスト構造

### 固定費（月額）
| 項目 | Year 1 | Year 3 |
|------|--------|--------|
| 人件費（5→15名） | ¥3,500,000 | ¥10,500,000 |
| オフィス賃料 | ¥200,000 | ¥500,000 |
| インフラ（AWS/Vercel） | ¥300,000 | ¥2,000,000 |
| マーケティング | ¥1,000,000 | ¥3,000,000 |
| その他経費 | ¥500,000 | ¥1,000,000 |
| **合計** | **¥5,500,000** | **¥17,000,000** |

### 変動費
- AWS S3ストレージ: ¥0.025/GB/月
- CDN転送: ¥0.114/GB
- AI API（OpenAI）: $0.03/1K tokens
- 決済手数料（Stripe）: 3.6%
- パートナー手数料: 20-30%

### 損益分岐点
```
Year 1:
月間収益: ¥4,000,000
月間コスト: ¥5,500,000
月間損失: -¥1,500,000
年間損失: -¥18,000,000

Year 2:
月間収益: ¥15,000,000
月間コスト: ¥10,000,000
月間利益: +¥5,000,000
年間利益: +¥60,000,000

Year 3:
月間収益: ¥30,400,000
月間コスト: ¥17,000,000
月間利益: +¥13,400,000
年間利益: +¥160,800,000
```

## 9.3 資金調達計画

### シードラウンド（Year 0-1）
- **調達額**: ¥50,000,000
- **使途**:
  - 開発費: ¥20,000,000
  - 人件費: ¥20,000,000
  - マーケティング: ¥7,000,000
  - その他: ¥3,000,000
- **投資家**: エンジェル、シードVC

### シリーズA（Year 1-2）
- **調達額**: ¥300,000,000
- **使途**:
  - 事業拡大: ¥150,000,000
  - 人材採用: ¥80,000,000
  - マーケティング: ¥50,000,000
  - 運転資金: ¥20,000,000
- **投資家**: VC、事業会社

### シリーズB（Year 3-4）
- **調達額**: ¥1,000,000,000
- **使途**:
  - 海外展開: ¥400,000,000
  - M&A: ¥300,000,000
  - 技術開発: ¥200,000,000
  - その他: ¥100,000,000

## 9.4 KPI設定

### 北極星指標（North Star Metric）
**月間アクティブユーザー（MAU）**

### 主要KPI
| KPI | Year 1 | Year 2 | Year 3 |
|-----|--------|--------|--------|
| 登録ユーザー数 | 10,000 | 50,000 | 150,000 |
| MAU | 5,000 | 30,000 | 90,000 |
| 有料会員数 | 2,000 | 10,000 | 30,000 |
| MRR | ¥4百万 | ¥15百万 | ¥30百万 |
| チャーンレート | 5% | 3% | 2% |
| NPS | 40 | 50 | 60 |
| CAC | ¥10,000 | ¥8,000 | ¥6,000 |
| LTV | ¥50,000 | ¥80,000 | ¥120,000 |
| LTV/CAC比 | 5.0 | 10.0 | 20.0 |

---

# 10. 開発ロードマップ

## 10.1 フェーズ1: MVP開発（3-6ヶ月）

### 目標
- 基本機能の実装
- ベータユーザー100名獲得
- フィードバック収集

### 実装機能
- ✅ ユーザー認証（登録・ログイン）
- ✅ 基本プロフィールページ
- ✅ 写真・ビデオアップロード
- ✅ シンプルな家系図
- ✅ 基本的な権限管理
- ✅ レスポンシブデザイン

### マイルストーン
| 週 | タスク |
|----|--------|
| 1-2 | プロジェクト初期設定、データベース設計 |
| 3-4 | 認証システム実装 |
| 5-6 | プロフィール・ダッシュボード |
| 7-8 | メディアアップロード機能 |
| 9-10 | 家系図基本機能 |
| 11-12 | 権限管理・テスト |

## 10.2 フェーズ2: 機能拡張（6-12ヶ月）

### 実装機能
- メッセージカプセル
- バーチャル供養空間（2D）
- AI文章支援（基本）
- QRコード連携
- モバイルアプリ（PWA）
- 決済システム
- オンライン法要（ベータ）

### 目標
- 有料ユーザー1,000名
- 提携寺院10寺
- MRR ¥150万

## 10.3 フェーズ3: 高度機能（12-18ヶ月）

### 実装機能
- DNA保存サービス
- AI音声・アバター
- 3Dバーチャル供養空間
- VR対応
- ソーシャルネットワーク機能
- 詳細な検索・探索
- API公開

### 目標
- 有料ユーザー5,000名
- 提携寺院50寺
- MRR ¥1,000万

## 10.4 フェーズ4: エコシステム構築（18ヶ月以降）

### 実装機能
- AR対応
- AIとの対話システム
- 遺伝子研究機関連携
- グローバル展開
- ブロックチェーン証明
- 長期保存技術

### 目標
- 有料ユーザー30,000名
- 海外展開開始
- MRR ¥3,000万

---

# 11. リスク管理

## 11.1 技術的リスク

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| データ消失 | 低 | 極大 | ・多重バックアップ<br>・地理的冗長化<br>・定期的復旧テスト |
| セキュリティ侵害 | 中 | 大 | ・多層防御<br>・定期的セキュリティ監査<br>・侵入検知システム |
| サービス停止 | 低 | 大 | ・冗長構成<br>・フェイルオーバー<br>・99.9%稼働率SLA |
| スケーラビリティ | 中 | 中 | ・初期から水平スケーリング設計<br>・負荷テスト |

## 11.2 事業リスク

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| 競合参入 | 高 | 中 | ・先行者利得確保<br>・独自機能開発<br>・特許取得 |
| 市場受容遅れ | 中 | 大 | ・教育的マーケティング<br>・無料プラン提供<br>・段階的機能展開 |
| 資金ショート | 低 | 極大 | ・計画的資金調達<br>・コスト管理<br>・収益多様化 |
| キーパーソン流出 | 中 | 大 | ・ストックオプション<br>・良好な労働環境<br>・知識の文書化 |

## 11.3 法的リスク

| リスク | 発生確率 | 影響度 | 対策 |
|--------|---------|--------|------|
| 個人情報漏洩 | 低 | 極大 | ・暗号化<br>・アクセス制御<br>・セキュリティ保険加入 |
| 著作権侵害 | 低 | 中 | ・利用規約明確化<br>・通報システム<br>・DMCA対応 |
| 法規制変更 | 中 | 中 | ・法務顧問契約<br>・業界団体参加<br>・ロビー活動 |
| 訴訟リスク | 低 | 大 | ・利用規約整備<br>・免責事項明記<br>・保険加入 |

## 11.4 リスク監視体制

### 月次レビュー
- KPI達成状況
- セキュリティインシデント
- ユーザーフィードバック
- 競合動向

### 四半期レビュー
- 財務状況
- 法規制動向
- 技術トレンド
- 組織体制

---

# 12. 品質保証

## 12.1 テスト戦略

### テストレベル
1. **単体テスト（Unit Test）**
   - カバレッジ目標: 80%以上
   - ツール: Jest
   - 対象: ビジネスロジック、ユーティリティ関数

2. **統合テスト（Integration Test）**
   - カバレッジ目標: 70%以上
   - ツール: Jest + Supertest
   - 対象: API、データベース連携

3. **E2Eテスト（End-to-End Test）**
   - カバレッジ目標: 主要フローの100%
   - ツール: Playwright
   - 対象: ユーザージャーニー、クリティカルパス

### テスト自動化
- プルリクエスト時に自動実行
- デイリーで全テスト実行
- 失敗時は即座に通知

## 12.2 パフォーマンステスト

### 目標値
- **ページロード時間**: < 2秒（FCP）
- **Time to Interactive**: < 3秒
- **API応答時間**: < 200ms（P95）
- **同時接続数**: 10,000+

### 負荷テスト
- ツール: k6, Artillery
- 頻度: リリース前必須
- シナリオ:
  - 通常負荷（平常時の2倍）
  - ピーク負荷（平常時の5倍）
  - ストレステスト（限界まで）

## 12.3 セキュリティテスト

### 定期実施項目
- 脆弱性スキャン（週次）
- ペネトレーションテスト（四半期）
- コード監査（半期）
- 依存関係チェック（毎日）

### ツール
- Snyk: 依存関係脆弱性
- OWASP ZAP: Webアプリ脆弱性
- SonarQube: コード品質

## 12.4 品質基準

### リリース判定基準
- [ ] すべてのテストが通過
- [ ] コードカバレッジ80%以上
- [ ] セキュリティ脆弱性なし（Critical/High）
- [ ] パフォーマンス目標達成
- [ ] ドキュメント更新完了
- [ ] ステークホルダー承認

---

# 13. 運用・保守

## 13.1 監視体制

### 監視項目
- **可用性**: サービス稼働率（目標99.9%）
- **パフォーマンス**: 応答時間、スループット
- **エラー率**: 4xx/5xxエラーの発生率
- **リソース**: CPU、メモリ、ディスク使用率
- **ビジネスKPI**: MAU、コンバージョン率

### アラート設定
| 項目 | 警告 | 緊急 |
|------|------|------|
| エラー率 | > 1% | > 5% |
| 応答時間 | > 1秒 | > 3秒 |
| CPU使用率 | > 70% | > 90% |
| ディスク空き | < 30% | < 10% |

### オンコール体制
- ローテーション制（週次）
- エスカレーションパス定義
- 平均応答時間: 15分以内

## 13.2 バックアップ戦略

### データベース
- **フル備**: 日次（0:00 JST）
- **増分バックアップ**: 時間毎
- **保存期間**: 30日
- **リージョン**: 東京 + 大阪（冗長）

### メディアファイル
- **S3バージョニング**: 有効
- **クロスリージョンレプリケーション**: 有効
- **ライフサイクルポリシー**:
  - 30日後: Intelligent-Tiering
  - 90日後: Glacier
  - 1年後: Deep Archive

### 復旧手順
- RPO（Recovery Point Objective）: 1時間
- RTO（Recovery Time Objective）: 4時間
- 四半期ごとに復旧訓練実施

## 13.3 インシデント対応

### インシデントレベル
| レベル | 定義 | 対応時間 |
|-------|------|----------|
| P0（Critical） | サービス全停止 | 即座 |
| P1（High） | 主要機能停止 | 1時間以内 |
| P2（Medium） | 一部機能停止 | 4時間以内 |
| P3（Low） | 軽微な不具合 | 24時間以内 |

### 対応フロー
1. 検知・報告
2. 初動対応（一次切り分け）
3. エスカレーション（必要時）
4. 原因調査
5. 恒久対策実施
6. 事後報告（ポストモーテム）

## 13.4 メンテナンス

### 定期メンテナンス
- **頻度**: 月次（第3日曜 2:00-4:00 JST）
- **内容**:
  - OSパッチ適用
  - データベース最適化
  - ログローテーション
  - 不要データ削除

### 緊急メンテナンス
- セキュリティパッチ適用時
- Critical不具合修正時
- 事前通知: 最低24時間前（可能な限り）

---

# 14. 付録

## 14.1 用語集

| 用語 | 説明 |
|------|------|
| デジタル遺産 | オンライン上に存在する個人のデジタル資産（写真、動画、SNSアカウント等） |
| 終活 | 人生の終わりに向けた活動（遺言作成、財産整理、葬儀準備等） |
| メモリアル | 故人を偲ぶための記念物や行事 |
| バーチャル供養 | デジタル空間で行う供養行為 |
| 家系図 | 家族の血縁関係を図式化したもの |
| タイムカプセル | 特定の時期まで開封しないメッセージや物品 |
| 二段階認証（2FA） | パスワードに加え、別の要素で認証を行うセキュリティ手法 |
| JWT | JSON Web Token。認証情報を安全に伝送するためのトークン形式 |
| GDPR | EU一般データ保護規則。個人データ保護に関する法規制 |
| SLA | Service Level Agreement。サービスレベル合意 |

## 14.2 参考資料

### 技術ドキュメント
- [Next.js Documentation](https://nextjs.org/docs)
- [Prisma Documentation](https://www.prisma.io/docs)
- [NextAuth.js Documentation](https://next-auth.js.org/)
- [Tailwind CSS Documentation](https://tailwindcss.com/docs)
- [AWS S3 Documentation](https://docs.aws.amazon.com/s3/)

### 市場調査レポート
- Custom Market Insights: Digital Legacy Market Report 2025
- 矢野経済研究所: 終活関連市場調査 2025
- Trust & Will: 2025 Legacy Planning Report

### 法規制
- 個人情報保護法（日本）
- GDPR（EU）
- デジタル遺産相続に関する法整備動向

## 14.3 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0 | 2024-12-29 | 初版作成 | - |

## 14.4 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロジェクトマネージャー | - | - | - |
| 技術責任者 | - | - | - |
| 事業責任者 | - | - | - |

---

**本書は機密文書です。無断複製・配布を禁じます。**

**Copyright © 2024 Eternal Link. All Rights Reserved.**
